# replibuild.toml - Complete Configuration Reference
# This is a fully documented example showing all available options

# ==============================================================================
# PROJECT METADATA
# ==============================================================================
[project]
name = "myproject"              # Project name (used for module name)
root = "."                      # Project root directory (absolute or relative)

# ==============================================================================
# COMPILATION SETTINGS
# ==============================================================================
[compile]

# Source files to compile (required)
source_files = [
    "src/main.cpp",
    "src/utils.cpp",
    "src/math.cpp"
]

# Include directories for headers
include_dirs = [
    "include",
    "/usr/local/include",
    "third_party/eigen"
]

# Compiler flags
# IMPORTANT: Use -g for DWARF extraction (struct definitions)
#            Use -fPIC for shared libraries
flags = [
    "-std=c++17",               # C++ standard (c++11, c++14, c++17, c++20)
    "-O2",                      # Optimization level (-O0, -O1, -O2, -O3)
    "-g",                       # ⭐ Debug info - REQUIRED for struct extraction
    "-fPIC",                    # ⭐ Position-independent code - REQUIRED for .so
    "-Wall",                    # Warnings
    "-Wextra",                  # Extra warnings
]

# Preprocessor defines
[compile.defines]
DEBUG = "1"
VERSION = "\"2.0.0\""
USE_DOUBLE_PRECISION = ""      # Empty value for flag-style defines

# ==============================================================================
# BINARY OUTPUT SETTINGS
# ==============================================================================
[binary]

# Binary type: "library" or "executable"
type = "library"                # Options: "library", "shared", "executable"

# Output name (optional - defaults based on project name)
output_name = "libmyproject.so" # For library: lib<name>.so
# output_name = "myproject"     # For executable: <name>

# ==============================================================================
# WRAPPER GENERATION SETTINGS
# ==============================================================================
[wrap]

# Enable automatic wrapper generation after build
enabled = true                  # Default: false

# Wrapper style: "basic", "advanced", or "introspective"
# - basic: Symbol-only extraction (~40% quality, no headers needed)
# - advanced: Header-aware with Clang.jl (~85% quality, requires headers)
# - introspective: Metadata-rich from DWARF (~95% quality, uses -g flag)
style = "introspective"         # Default: auto-detect

# Julia module name (optional - defaults to capitalized project name)
module_name = "MyProject"       # Generated: module MyProject ... end

# Header files for advanced/introspective wrapping
headers = [
    "include/myproject.h",
    "include/types.h"
]

# Generate test file
generate_tests = false          # Default: false

# Generate documentation
generate_docs = true            # Default: true

# ==============================================================================
# TYPE MAPPING & VALIDATION SETTINGS (FFI Generation)
# ==============================================================================
[types]

# Type strictness mode: "strict", "warn", or "permissive"
# - strict: Error on any unmapped type (recommended for production)
# - warn: Warn and fallback to Any or best guess (useful for development)
# - permissive: Silent fallback to Any (legacy compatibility)
strictness = "warn"             # Default: "warn"

# Allow unknown struct-like types to be treated as opaque structs
# When true: "Matrix3x3" (unknown) → Matrix3x3 (Julia struct name)
# When false: Unknown structs cause error in strict mode
allow_unknown_structs = true    # Default: true

# Allow unknown enums to be mapped to Cint
# When true: Unknown enums → Cint
# When false: Enums must be explicitly extracted from DWARF
allow_unknown_enums = false     # Default: false

# Allow function pointers to be mapped to Ptr{Cvoid}
# When true: "int (*callback)(double)" → Ptr{Cvoid}
# When false: Function pointers cause error in strict mode
allow_function_pointers = true  # Default: true

# Custom type mappings (C/C++ type → Julia type)
[types.custom]
"MyCustomType" = "MyJuliaStruct"
"ErrorCode" = "Cint"
"Handle" = "Ptr{Cvoid}"
"Matrix3x3" = "Matrix3x3"       # Explicitly map custom struct

# ==============================================================================
# WORKFLOW SETTINGS
# ==============================================================================
[workflow]

# Build stages to execute
stages = ["compile", "link", "binary"]  # Can add "wrap" here

# Parallel compilation
parallel = true                 # Default: true

# ==============================================================================
# LLVM TOOLCHAIN SETTINGS
# ==============================================================================
[llvm]

# Toolchain discovery mode
# - "auto": Detect system LLVM automatically
# - "system": Use system LLVM at /usr
# - "custom": Use custom path
toolchain = "auto"              # Default: "auto"

# Custom LLVM root (only used if toolchain = "custom")
# llvm_root = "/opt/llvm-15"

# Override specific tools (optional)
# clang = "/usr/bin/clang++-15"
# llvm_link = "/usr/bin/llvm-link-15"
# opt = "/usr/bin/opt-15"

# ==============================================================================
# CACHING SETTINGS
# ==============================================================================
[cache]

# Enable incremental build cache
enabled = true                  # Default: true

# Cache directory (relative to project root)
cache_dir = ".replibuild_cache" # Default: .replibuild_cache

# Force clean build (ignore cache)
force_rebuild = false           # Default: false

# ==============================================================================
# OUTPUT DIRECTORIES
# ==============================================================================
[output]

# Build output directory
build_dir = "build"             # Default: "build"

# Julia bindings output directory
julia_dir = "julia"             # Default: "julia"

# LLVM IR output directory
ir_dir = "build/ir"             # Default: "build/ir"

# ==============================================================================
# LINKING SETTINGS (Advanced)
# ==============================================================================
[link]

# Additional link libraries
libraries = [
    "m",                        # libm (math)
    "pthread",                  # pthreads
    "stdc++",                   # C++ standard library
]

# Library search paths
library_dirs = [
    "/usr/local/lib",
    "/opt/custom/lib"
]

# Additional linker flags
flags = [
    "-Wl,-rpath,/usr/local/lib",
    "-Wl,--no-undefined"
]

# ==============================================================================
# DISCOVERY SETTINGS (Auto-generated by RepliBuild.Discovery.discover())
# ==============================================================================
[discovery]

# Last discovery timestamp
timestamp = "2025-11-24T21:00:00"

# Discovery mode used
mode = "auto"

# Files scanned
files_scanned = 15

# ==============================================================================
# METADATA (Generated by RepliBuild)
# ==============================================================================
[metadata]

# RepliBuild version used to generate this config
replibuild_version = "2.0.0"

# Configuration format version
config_version = "1.0"

# Last build timestamp
# last_build = "2025-11-24T21:30:00"

# ==============================================================================
# EXAMPLE CONFIGURATIONS
# ==============================================================================

# MINIMAL CONFIGURATION:
# [project]
# name = "mylib"
# root = "."
#
# [compile]
# source_files = ["src/main.cpp"]
# flags = ["-std=c++17", "-fPIC", "-g"]
#
# [binary]
# type = "library"

# SIMPLE LIBRARY:
# [project]
# name = "mathlib"
# root = "."
#
# [compile]
# source_files = ["src/math.cpp"]
# include_dirs = ["include"]
# flags = ["-std=c++17", "-fPIC", "-O2", "-g"]
#
# [binary]
# type = "library"
#
# [llvm]
# toolchain = "auto"
#
# [cache]
# enabled = true

# EXECUTABLE WITH WRAPPER:
# [project]
# name = "demo"
# root = "."
#
# [compile]
# source_files = ["src/main.cpp", "src/lib.cpp"]
# include_dirs = ["include"]
# flags = ["-std=c++17", "-O2", "-g"]
#
# [binary]
# type = "executable"
#
# [wrap]
# enabled = true
# style = "introspective"
#
# [workflow]
# stages = ["compile", "link", "binary", "wrap"]

# ==============================================================================
# NOTES
# ==============================================================================

# 1. DWARF Extraction:
#    - MUST use -g flag in compile.flags
#    - Without -g: no struct definitions extracted
#    - With -g: full type information available

# 2. Shared Libraries:
#    - MUST use -fPIC flag for .so files
#    - Set binary.type = "library" or "shared"

# 3. Auto-Generation:
#    Run: RepliBuild.Discovery.discover()
#    This scans your project and generates basic config

# 4. Manual Editing:
#    Edit this file to customize compilation settings
#    Then run: RepliBuild.build()

# 5. Wrapper Quality:
#    - basic: No headers, symbol names only (~40%)
#    - advanced: Requires headers (~85%)
#    - introspective: Uses -g DWARF data (~95%) ⭐ RECOMMENDED

# ==============================================================================
# TROUBLESHOOTING
# ==============================================================================

# "No metadata found":
#   → Add -g to compile.flags

# "Library not found":
#   → Check binary.type = "library"
#   → Check -fPIC in compile.flags

# "Compilation failed":
#   → Check source_files paths are correct
#   → Check include_dirs exist
#   → Try adding -v flag to see compiler output

# "Wrapper quality poor":
#   → Use -g flag for DWARF extraction
#   → Set wrap.style = "introspective"
#   → Provide headers in wrap.headers

# ==============================================================================
